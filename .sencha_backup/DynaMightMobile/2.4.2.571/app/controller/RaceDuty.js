/*
 * File: app/controller/RaceDuty.js
 *
 * This file was generated by Sencha Architect version 3.2.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Sencha Touch 2.4.x library, under independent license.
 * License of Sencha Architect does not include license for Sencha Touch 2.4.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('DynaMightMobile.controller.RaceDuty', {
    extend: 'Ext.app.Controller',

    config: {
        refs: {
            raceDutySearchTxt: 'searchfield#raceDutySearchTxt',
            raceDutyLst: 'dataview#raceDutyLst',
            crewMemberSearch: 'searchfield#crewMemberSearch',
            crewMembersLst: 'dataview#crewMembersLst',
            dutyTypeSelectField: 'selectfield#dutyTypeSelectField'
        },

        control: {
            "searchfield#raceDutySearchTxt": {
                keyup: 'onRaceSearch'
            },
            "searchfield#crewMemberSearch": {
                keyup: 'onCrewSearch'
            },
            "button#setRaceDutyBtn": {
                tap: 'onSetRaceDuty'
            }
        }
    },

    onRaceSearch: function(textfield, e, eOpts) {
        var me = this,
            raceStore = CreateStore("race"),
            val = textfield.getValue();


        raceStore.execConfig({
            params: {
                entityViewID: GetEntityViewByName('Races').entityviewid ,
                filters:  val? "WHERE name like '%" + val + "%'" :  "WHERE 1=2"
            }
        });

        this.getRaceDutyLst().setStore(raceStore);
    },

    onCrewSearch: function(textfield, e, eOpts) {
        var crewM = CreateStore('crewmember'),
            val = textfield.getValue();
        crewM.execConfig({
            params: {
                entityViewID: GetEntityViewByName('Crew Members').entityviewid ,
                filters: val ? " WHERE ya like '%" +val + "%'" : " WHERE 1=2"
            }
        });
        this.getCrewMembersLst().setStore(crewM);
    },

    onSetRaceDuty: function(button, e, eOpts) {
        var me= this,
            raceList = me.getRaceDutyLst(),
            crewList = me.getCrewMembersLst(),
            selectedRace = raceList.selected,
            selectedCrew = crewList.selected,
            dutyType = me.getDutyTypeSelectField().getValue(),

            items =[],
            rec = '',
            crew = '';

        if(selectedRace.length === 0){
            Ext.Msg.alert('Ooops','Plese select at least one race');
            return;
        }

        if(selectedCrew.length === 0){
            Ext.Msg.alert('Ooops','Plese select at least one crew member');
            return;
        }
        crew = selectedCrew.items[0].data.crewmemberid;

        for(var i = 0;i < selectedRace.length; i++){
            rec = selectedRace.items[i].data;
            rec.crewmemberid = crew;
            rec.dutytypeid = dutyType;
            items.push(rec);
        }
        AJAXCommand({
            params: items,
            method: 'SetRaceCrewDuty',
            scope: me,
            callback: function(status, message, obj, scope) {
                //debugger;
                if (status) {

                    this.scope.getCrewMembersLst().getStore().removeAll();
                    this.scope.getRaceDutyLst().getStore().removeAll();
                    this.scope.getRaceDutySearchTxt().setValue('');
                    this.scope.getCrewMemberSearch().setValue('');

                }
                else
                {
                    Ext.Msg.alert('Ooops','Failed to set race message');
                }
            }
        });

    }

});